---
// Popup Component - Shows once, then becomes a small badge in bottom-left
interface Props {
  enabled?: boolean;
  title?: string;
  message?: string;
  buttonText?: string;
  buttonLink?: string;
  secondaryButtonText?: string;
  secondaryButtonLink?: string;
  lang?: 'en' | 'fr';
  image?: string;
  badge?: string;
}

const {
  enabled = true,
  title = "Open Day - January 25th",
  message = "Join us for our upcoming Open Day! Meet our teachers, tour our campus, and discover our unique nature-based approach to education.",
  buttonText = "Register Now",
  buttonLink = "/en/contact",
  secondaryButtonText = "",
  secondaryButtonLink = "",
  lang = 'en',
  image = "",
  badge = ""
} = Astro.props;

const closeText = lang === 'fr' ? 'Fermer' : 'Close';
const badgeText = lang === 'fr' ? 'Journee Portes Ouvertes' : 'Open Day';
---

{enabled && (
  <>
    <!-- Full Popup Modal (shown only on first visit) -->
    <div id="announcement-popup" class="fixed inset-0 z-[9999] hidden">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="popup-backdrop"></div>

      <!-- Popup Container -->
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-3xl shadow-2xl max-w-lg w-full overflow-hidden transform transition-all" id="popup-content">

          <!-- Close Button -->
          <button id="popup-close" class="absolute top-4 right-4 z-10 w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-110" aria-label={closeText}>
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>

          <!-- Image Header -->
          {image && (
            <div class="relative h-48 overflow-hidden">
              <img src={image} alt="" class="w-full h-full object-cover" />
              <div class="absolute inset-0 bg-gradient-to-t from-[#1e3d29]/80 to-transparent"></div>
              {badge && (
                <span class="absolute bottom-4 left-4 px-3 py-1 bg-[#c9a962] text-[#1e3d29] text-sm font-bold rounded-full">
                  {badge}
                </span>
              )}
            </div>
          )}

          <!-- No Image - Decorative Header -->
          {!image && (
            <div class="relative h-24 bg-gradient-to-r from-[#2d5a3d] to-[#4a7c5c] overflow-hidden">
              <div class="absolute inset-0 opacity-20">
                <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                  <defs>
                    <pattern id="leaves" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                      <circle cx="10" cy="10" r="3" fill="white" opacity="0.3"/>
                    </pattern>
                  </defs>
                  <rect width="100" height="100" fill="url(#leaves)"/>
                </svg>
              </div>
              {badge && (
                <div class="absolute bottom-4 left-6">
                  <span class="px-4 py-2 bg-[#c9a962] text-[#1e3d29] text-sm font-bold rounded-full">
                    {badge}
                  </span>
                </div>
              )}
            </div>
          )}

          <!-- Content -->
          <div class="p-8">
            <h3 class="text-2xl md:text-3xl font-bold text-[#1e3d29] mb-4">{title}</h3>
            <p class="text-gray-600 text-lg leading-relaxed mb-6">{message}</p>

            <!-- CTA Buttons -->
            <div class="flex flex-col sm:flex-row gap-3">
              <a href={buttonLink} class="flex-1 inline-flex items-center justify-center px-6 py-4 bg-gradient-to-r from-[#2d5a3d] to-[#4a7c5c] text-white font-bold rounded-xl hover:from-[#1e3d29] hover:to-[#2d5a3d] transition-all shadow-lg hover:shadow-xl">
                {buttonText}
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                </svg>
              </a>
              {secondaryButtonText && secondaryButtonLink && (
                <a href={secondaryButtonLink} class="flex-1 inline-flex items-center justify-center px-6 py-4 bg-gray-100 text-[#2d5a3d] font-bold rounded-xl hover:bg-gray-200 transition-all">
                  {secondaryButtonText}
                </a>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mini Badge (shown after popup is closed) - Bottom Left -->
    <div id="mini-badge" class="fixed bottom-6 left-6 z-50 hidden">
      <button id="mini-badge-btn" class="group flex items-center gap-3 px-4 py-3 bg-white rounded-2xl shadow-xl hover:shadow-2xl transition-all border border-gray-100 hover:-translate-y-1">
        <div class="w-10 h-10 bg-gradient-to-br from-[#2d5a3d] to-[#4a7c5c] rounded-xl flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <div class="text-left">
          <div class="text-sm font-bold text-[#1e3d29]">{badgeText}</div>
          <div class="text-xs text-gray-500">{lang === 'fr' ? 'Cliquez pour en savoir plus' : 'Click for details'}</div>
        </div>
        <div class="w-2 h-2 bg-[#c9a962] rounded-full animate-pulse"></div>
      </button>
    </div>
  </>
)}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('announcement-popup');
    const closeBtn = document.getElementById('popup-close');
    const backdrop = document.getElementById('popup-backdrop');
    const miniBadge = document.getElementById('mini-badge');
    const miniBadgeBtn = document.getElementById('mini-badge-btn');

    if (!popup || !miniBadge) return;

    // Check if popup was already shown this session
    const popupShown = sessionStorage.getItem('popup-shown');

    if (!popupShown) {
      // First visit - show popup after delay
      setTimeout(() => {
        showPopup();
        sessionStorage.setItem('popup-shown', 'true');
      }, 2500);
    } else {
      // Already seen - show mini badge
      miniBadge.classList.remove('hidden');
    }

    function showPopup() {
      popup.classList.remove('hidden');
      popup.classList.add('flex');
      document.body.style.overflow = 'hidden';

      const content = document.getElementById('popup-content');
      if (content) {
        content.style.opacity = '0';
        content.style.transform = 'scale(0.95) translateY(20px)';
        requestAnimationFrame(() => {
          content.style.transition = 'all 0.3s ease-out';
          content.style.opacity = '1';
          content.style.transform = 'scale(1) translateY(0)';
        });
      }
    }

    function closePopup() {
      const content = document.getElementById('popup-content');
      if (content) {
        content.style.opacity = '0';
        content.style.transform = 'scale(0.95) translateY(20px)';
      }

      setTimeout(() => {
        popup.classList.add('hidden');
        popup.classList.remove('flex');
        document.body.style.overflow = '';

        // Show mini badge after closing
        miniBadge.classList.remove('hidden');
      }, 200);
    }

    // Event listeners
    closeBtn?.addEventListener('click', closePopup);
    backdrop?.addEventListener('click', closePopup);

    // Mini badge click - reopen popup
    miniBadgeBtn?.addEventListener('click', () => {
      miniBadge.classList.add('hidden');
      showPopup();
    });

    // ESC key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !popup.classList.contains('hidden')) {
        closePopup();
      }
    });
  });
</script>

<style>
  #announcement-popup {
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  #mini-badge {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>
